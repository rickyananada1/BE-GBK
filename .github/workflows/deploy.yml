name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Change this to your deployment branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'
          cache: 'maven'

      - name: Install SSH client
        run: sudo apt-get install -y openssh-client

      - name: Install Expect
        run: sudo apt-get install -y expect

      - name: Deploy to Server
        env:
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          echo "Using SCP to copy JAR file to server"
          expect << EOF
          spawn scp -i $env(SSH_PRIVATE_KEY) -o StrictHostKeyChecking=no target/SSec-0.0.1-SNAPSHOT.jar ${SERVER_USERNAME}@213.210.37.2:/opt/SSec-0.0.1-SNAPSHOT.jar
          expect {
            "assword: " {
              send "$env(SERVER_PASSWORD)\r"
              exp_continue
            }
          }
          expect eof
          EOF
          
          echo "Using SSH to run start_app.sh on server"
          expect << EOF
          spawn ssh -i $env(SSH_PRIVATE_KEY) -o StrictHostKeyChecking=no ${SERVER_USERNAME}@213.210.37.2
          expect {
            "assword: " {
              send "$env(SERVER_PASSWORD)\r"
              exp_continue
            }
            "Permission denied" {
              exit 1
            }
          }
          expect "\$ "
          send "chmod +x /opt/start_app.sh\r"
          expect "\$ "
          send "/opt/start_app.sh\r"
          expect "\$ "
          send "exit\r"
          expect eof
          EOF
