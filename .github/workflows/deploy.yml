name: CI/CD Pipeline

on:
  push:
    branches:
      - main  # Change this to your deployment branch

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          distribution: 'adopt'
          java-version: '17'
          cache: 'maven'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Install Expect
        run: sudo apt-get install -y expect

      - name: Deploy to Server
        env:
          SERVER_USERNAME: ${{ secrets.SERVER_USERNAME }}
          SERVER_PASSWORD: ${{ secrets.SERVER_PASSWORD }}
        run: |
          echo "Using SCP to copy JAR file to server"
          expect << EOF
          spawn scp target/SSec-0.0.1-SNAPSHOT.jar ${SERVER_USERNAME}@213.210.37.2:/opt/SSec-0.0.1-SNAPSHOT.jar
          expect {
            "(yes/no)?" {
              send "yes\r"
              exp_continue
            }
            "password:" {
              send "${SERVER_PASSWORD}\r"
            }
          }
          expect eof
          EOF

          echo "Using SSH to run start_app.sh on server"
          expect << EOF
          spawn ssh ${SERVER_USERNAME}@213.210.37.2
          expect {
            "(yes/no)?" {
              send "yes\r"
              exp_continue
            }
            "password:" {
              send "${SERVER_PASSWORD}\r"
            }
          }
          expect "\$ "
          send "chmod +x /opt/start_app.sh\r"
          expect "\$ "
          send "/opt/start_app.sh\r"
          expect "\$ "
          send "exit\r"
          expect eof
          EOF
